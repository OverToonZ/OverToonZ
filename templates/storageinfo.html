{% extends "_base.html" %} {% load static %} {% load custom_function %} {% block title %}
<title>Community Forum</title>
{% endblock title %} {% block content %}
<body class="bgbodymain container font-Roboto">
  {% include 'nav.html' %}
  <div class="text-center text-lg text-danger my-2">Storage Analytics</div>
  <div class="d-flex justify-content-start mb-3">
    <button type="button" class="btn btn-outline-info mx-2" data-bs-toggle="modal" data-bs-target="#addstorage">Add Storage</button>
    <button type="button" class="btn btn-outline-warning mx-2" data-bs-toggle="modal" data-bs-target="#modifystorage">Modify Storage</button>
  </div>
  <div
    class="modal fade"
    tabindex="-1"
    aria-labelledby="exampleModalLabel"
    aria-hidden="true"
    id="addstorage"
    data-bs-backdrop="static"
    data-bs-keyboard="false"
  >
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Storage</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form class="mx-2" action="" method="post">
          {% csrf_token %}
          <div class="modal-body">
            <div class="mb-3 row">
              <div class="col">
                <label for="UserID" class="form-label">User Name</label>
                <input type="text" class="form-control" id="UserID" name="User" placeholder="User Name" />
              </div>
              <div class="col">
                <label for="EmailID" class="form-label">Email</label>
                <input type="email" class="form-control" id="EmailID" name="Email" placeholder="Email" />
              </div>
            </div>

            <div class="mb-3 row">
              <div class="col">
                <label for="Passkey" class="form-label">Password</label>
                <input type="text" class="form-control" id="Passkey" name="PassKey" placeholder="Password" />
              </div>
              <div class="col">
                <label for="size" class="form-label">Occupied Size</label>
                <input type="number" class="form-control" id="size" name="Size" step="0.01" placeholder="Size" />
              </div>
            </div>

            <div class="mb-3 row">
              <div class="col">
                <label for="Recovery" class="form-label">Recovery Key</label>
                <input type="text" class="form-control" id="Recovery" name="RecoverKey" placeholder="Recovery Key" />
              </div>

              <div class="col">
                <label for="storage" class="form-label">Storage Type</label>
                <input
                  list="typestorage"
                  class="form-select"
                  aria-label="Default select example"
                  id="storage"
                  name="Storage_Type"
                  placeholder="Storage Type"
                />
                <datalist id="typestorage">
                  <option value="MEGA">MEGA</option>
                  <option value="G-Drive">G-Drive</option>
                  <option value="Others">Others</option>
                </datalist>
              </div>
            </div>
            <div class="mb-3">
              <label for="Contains" class="form-label">Contains</label>
              <textarea class="form-control" id="Contains" rows="3" name="Contain_file"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary" name="add">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div
    class="modal fade"
    tabindex="-1"
    aria-labelledby="exampleModalLabel"
    aria-hidden="true"
    id="modifystorage"
    data-bs-backdrop="static"
    data-bs-keyboard="false"
  >
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Modify Storage</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form class="mx-2" action="" method="post">
          {% csrf_token %}
          <div class="modal-body">
            <div class="mb-3 row">
              <div class="col-8 mx-auto">
                <label for="mstorage1" class="form-label">Storage Type</label>
                <input list="mtypestorage1" class="form-select" id="mstorage1" name="Storage_id" placeholder="Storage ID" />
                <datalist id="mtypestorage1">
                  {% for ids in ids %}
                  <option value="{{ids}}">Storage #{{ids}}</option>
                  {% endfor %}
                </datalist>
              </div>
            </div>
            <div class="mb-3 row">
              <div class="col">
                <label for="UserID1" class="form-label">User Name</label>
                <input type="text" class="Modifyfield form-control" id="UserID1" name="User" placeholder="User Name" />
              </div>
              <div class="col">
                <label for="EmailID1" class="form-label">Email</label>
                <input type="email" class="Modifyfield form-control" id="EmailID1" name="Email" placeholder="Email" />
              </div>
            </div>

            <div class="mb-3 row">
              <div class="col">
                <label for="Passkey1" class="form-label">Password</label>
                <input type="text" class="Modifyfield form-control" id="Passkey1" name="PassKey" placeholder="Password" />
              </div>
              <div class="col">
                <label for="size1" class="form-label">Occupied Size</label>
                <input type="number" class="Modifyfield form-control" id="size1" name="Size" step="0.01" placeholder="Size" />
              </div>
            </div>

            <div class="mb-3 row">
              <div class="col">
                <label for="Recovery1" class="form-label">Recovery Key</label>
                <input type="text" class="Modifyfield form-control" id="Recovery1" name="RecoverKey" placeholder="Recovery Key" />
              </div>

              <div class="col">
                <label for="storage1" class="form-label">Storage Type</label>
                <input
                  list="typestorage1"
                  class="Modifyfield form-select"
                  aria-label="Default select example"
                  id="storage1"
                  name="Storage_Type"
                  placeholder="Storage Type"
                />
                <datalist id="typestorage1">
                  <option value="MEGA">MEGA</option>
                  <option value="G-Drive">G-Drive</option>
                  <option value="Others">Others</option>
                </datalist>
              </div>
            </div>
            <div class="mb-3">
              <label for="Contains1" class="form-label">Contains</label>
              <textarea class="Modifyfield form-control" id="Contains1" rows="3" name="Contain_file"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary" name="modify">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div>
    <div class="card mb-3">
      <div class="card-header text-base d-flex justify-content-between align-items-center">
        <div class="text-base fw-bold">Overall Storage</div>
      </div>
      <div class="card-body d-flex justify-content-center flex-wrap">
        <div class="card chart-container border-0 mx-3" style="height: 10rem; width: 10rem" id="storagedata">
          <canvas id="All" data-free="{{free}}" data-occupied="{{occupiedsize}}"></canvas>
        </div>
        <div class="mx-3">
          <p class="card-title text-sm m-0 p-0 mb-2"><span class="fw-bold text-base">Total Storage Accounts : </span>{{accounts}} Accounts</p>
          <p class="card-text text-sm m-0 p-0 mb-2"><span class="fw-bold text-base"> Total Storage Size : </span>{{totalsize}} GB</p>
          <p class="card-text text-sm m-0 p-0 mb-2"><span class="fw-bold text-base"> Total Occupied Size : </span> {{occupiedsize}} GB</p>
          <p class="card-text text-sm m-0 p-0 mb-2"><span class="fw-bold text-base"> Total Free Size : </span> {{free}} GB</p>
        </div>
      </div>
    </div>
    {% for data in storage %} {% if data.storagetype == "MEGA" %}
    <div class="card mb-3">
      <div class="card-header text-base d-flex justify-content-between align-items-center">
        <div class="text-base fw-bold">Storage #{{ data.id }}</div>
        <div class="text-xs fst-italic">{{data.storagetype}}</div>
      </div>
      <div class="card-body d-flex justify-content-between flex-wrap">
        <div>
          <p class="card-title text-sm m-0 p-0 mb-2"><span class="fw-bold text-base">Username : </span>{{data.username}}</p>
          <p class="card-text text-sm m-0 p-0 mb-2"><span class="fw-bold text-base">Email : </span>{{data.email}}</p>
          <p class="card-text text-sm m-0 p-0 mb-2"><span class="fw-bold text-base">Key : </span>{{data.passkey}}</p>
          <p class="card-text text-sm m-0 p-0 mb-2"><span class="fw-bold text-base">Recovery Key : </span>{{data.recoverykey}}</p>
        </div>
        <div>
          <p class="card-text text-base fw-bold">Files :</p>

          {% for key, value in data.files.items %}
          <p class="card-text text-sm text-muted m-0 p-0 mb-2">{{ forloop.counter }}. {{ key }} - {{value}}</p>
          {% endfor %}
        </div>

        <div class="card chart-container border-0" style="height: 10rem; width: 10rem" id="data{{ forloop.counter }}">
          <canvas id="chart{{ forloop.counter }}" data-free="{{data.availsize}}" data-occupied="{{data.occupiedsize}}"></canvas>
        </div>
      </div>
    </div>

    {% else %}
    <div class="card mb-3">
      <div class="card-header text-base d-flex justify-content-between align-items-center">
        <div class="text-base fw-bold">Storage #{{ data.id }}</div>
        <div class="text-xs fst-italic">{{data.storagetype}}</div>
      </div>
      <div class="card-body d-flex justify-content-between flex-wrap">
        <div>
          <p class="card-title text-sm m-0 p-0 mb-2"><span class="fw-bold text-base">Username : </span>{{data.username}}</p>
          <p class="card-text text-sm m-0 p-0 mb-2"><span class="fw-bold text-base">Email : </span>{{data.email}}</p>
          <p class="card-text text-sm m-0 p-0 mb-2"><span class="fw-bold text-base">Key : </span>{{data.passkey}}</p>
          <!-- <p class="card-text text-sm m-0 p-0 mb-2"><span class="fw-bold text-base">Recovery Key : </span>{{data.recoverykey}}</p> -->
        </div>
        <div>
          <p class="card-text text-base fw-bold">Files :</p>

          {% for key, value in data.files.items %}
          <p class="card-text text-sm text-muted m-0 p-0 mb-2">{{ forloop.counter }}. {{ key }} - {{value}}</p>
          {% endfor %}
        </div>

        <div class="card chart-container border-0" style="height: 10rem; width: 10rem" id="data{{ forloop.counter }}">
          <canvas id="chart{{ forloop.counter }}" data-free="{{data.availsize}}" data-occupied="{{data.occupiedsize}}"></canvas>
        </div>
      </div>
    </div>
    {% endif %} {% endfor %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <script>
    var charts = [];

    // Function to create a doughnut chart
    function createDoughnutChart(canvas) {
      var ctx = canvas.getContext("2d");

      // Get the values from data attributes
      var occupied = parseFloat($(canvas).data("occupied"));
      var free = parseFloat($(canvas).data("free"));

      var chart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["Free", "Occupied"],
          datasets: [
            {
              data: [free, occupied],
              backgroundColor: ["#0538F2", "#FC0A0A"],
              hoverOffset: 4,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: {
              callbacks: {
                label: function (tooltipItem) {
                  // Get the data value
                  var value = tooltipItem.raw;

                  // Check the label and return custom tooltip text
                  if (tooltipItem.label === "Occupied") {
                    return value + " GB Occupied";
                  } else if (tooltipItem.label === "Free") {
                    return value + " GB Free";
                  }
                },
              },
            },
            legend: {
              position: "bottom",
              labels: {
                font: {
                  size: 12,
                },
                boxWidth: 10,
                padding: 10,
              },
            },
          },
        },
      });
      charts.push(chart);
      return chart;
    }

    // Initialize the charts
    $(document).ready(function () {
      $(".chart-container canvas").each(function () {
        createDoughnutChart(this);
      });
    });

    // // Example function to update chart data dynamically using jQuery
    // function updateChart(index, newOccupied, newFree) {
    //   var chart = charts[index];
    //   chart.data.datasets[0].data = [newOccupied, newFree]; // Update the data
    //   chart.update(); // Refresh the chart to show updated data
    // }

    // // Example: Updating chart 1 (Disk 1) after 3 seconds
    // setTimeout(function () {
    //   updateChart(0, 150, 50); // Update with new values
    // }, 3000);
  </script>
  <script>
    $(document).ready(function () {
      $(".Modifyfield").prop("disabled", true);
      $("#mstorage1").change(function () {
        const ids = $(this).val();
        $(".Modifyfield").prop("disabled", true);
        $.ajax({
          url: '{% url "storage" %}',
          type: "POST",
          data: {
            selected_ids: ids,
            formuse: "ModifyStorage",
            csrfmiddlewaretoken: "{{ csrf_token }}",
          },
          success: function (response) {
            const res = response.updated_value;
            for (const key in res) {
              $(`#${key}`).val(res[key]);
            }
            $(".Modifyfield").prop("disabled", false);
          },
          error: function (response) {
            console.log("Error:", response);
          },
        });
      });
    });
  </script>
</body>
{% endblock content %}
